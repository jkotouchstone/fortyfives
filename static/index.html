<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>45's Game - Learn & Play</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* --- Basic Styles --- */
    body {
      font-family: sans-serif;
      background-color: #35654d;
      margin: 0;
      padding: 20px;
      text-align: center;
      color: #fff;
    }
    .container {
      position: relative;
      max-width: 900px;
      margin: auto;
      background: rgba(0,0,0,0.7);
      padding: 20px;
      border-radius: 8px;
    }
    /* --- Panels for Options and Instructions --- */
    #game-options, #instructions {
      max-width: 900px;
      margin: 20px auto;
      background: rgba(255,255,255,0.1);
      padding: 10px;
      border-radius: 8px;
    }
    #instructions {
      text-align: left;
      font-size: 14px;
      display: none;
    }
    /* --- Tutorial Modal --- */
    #tutorial-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #tutorial-content {
      background: #fff;
      color: #000;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      text-align: left;
    }
    /* --- Dealer Indicator & Logo --- */
    .dealer-indicator {
      display: inline-block;
      background: white;
      color: black;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      line-height: 50px;
      text-align: center;
      font-weight: bold;
      margin-left: 10px;
    }
    #logo {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 48px;
      font-weight: bold;
      opacity: 0.5;
      pointer-events: none;
    }
    .section { margin: 20px 0; }
    .hidden { display: none; }
    .cards-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
    .card {
      display: inline-block;
      width: 60px;
      height: 90px;
      border: 1px solid #333;
      border-radius: 5px;
      line-height: 90px;
      margin: 5px;
      cursor: pointer;
      user-select: none;
      background-color: #fff;
      color: #000;
    }
    .card.selected { background: #ffeb3b; }
    button {
      padding: 10px 15px;
      margin: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    /* --- Display Areas --- */
    #trump-display { font-weight: bold; margin-bottom: 10px; }
    #dealer-info { margin-bottom: 10px; }
    #competitor-bid { font-size: 16px; font-weight: bold; margin-bottom: 5px; color: #ffeb3b; }
    #competitor-hand-info { font-size: 14px; margin-top: 5px; color: #ffeb3b; }
    #trick-log {
      margin-top: 10px;
      text-align: left;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      background: #fafafa;
      padding: 10px;
      border: 1px solid #ccc;
      font-size: 14px;
      max-height: 150px;
      overflow-y: auto;
      color: #000;
    }
    #scoreboard-section {
      border-top: 2px solid #ffeb3b;
      padding-top: 10px;
    }
    #draw-phase-instructions { margin-top: 10px; font-style: italic; }
    #feedback {
      background: rgba(255,255,255,0.2);
      padding: 10px;
      border-radius: 5px;
      margin: 10px auto;
      max-width: 800px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <!-- Tutorial Modal -->
  <div id="tutorial-modal">
    <div id="tutorial-content">
      <h2>Welcome to Forty‑Fives!</h2>
      <p><strong>How to Play:</strong></p>
      <ol>
        <li>
          <strong>Cards & Setup:</strong><br>
          You and the computer each get 5 cards, and 3 extra cards (the kitty) are set aside.
        </li>
        <li>
          <strong>Bidding:</strong><br>
          You guess how many points you can win by choosing 15, 20, 25, or 30. The computer also bids. The higher bid wins, and that person gets to choose the special trump suit.
        </li>
        <li>
          <strong>Trump Suit:</strong><br>
          The trump suit is extra powerful and beats other suits. Remember: the Ace of Hearts is always trump!
        </li>
        <li>
          <strong>Kitty & Discard:</strong><br>
          The winner of the bid adds the kitty to their hand, then picks their best 5 cards.
        </li>
        <li>
          <strong>Drawing Cards:</strong><br>
          If you have less than 5 cards after discarding, you draw extra cards.
        </li>
        <li>
          <strong>Playing Tricks:</strong><br>
          In each trick, both you and the computer play one card. The winner of the trick gets 5 points, and sometimes a bonus trick gives 5 extra points.
        </li>
        <li>
          <strong>Scoring:</strong><br>
          If you were the bidder and don’t get as many points as you bid, you lose that many points instead! The game goes on until someone reaches 120 points.
        </li>
      </ol>
      <p>
        Watch the examples on the screen as the computer explains its moves.
      </p>
      <button onclick="closeTutorial()">Close Tutorial</button>
    </div>
  </div>

  <!-- Game Options Panel -->
  <div id="game-options">
    <h2>Game Options</h2>
    <label for="mode-select">Select Game Mode:</label>
    <select id="mode-select">
      <option value="2p">2-Player (You vs. Computer)</option>
      <!-- Additional modes can be added later -->
    </select>
    <label>
      <input type="checkbox" id="instruction-mode"> Enable Tutorial Mode
    </label>
    <button onclick="startGame()">Start Game</button>
    <button onclick="openTutorial()">Show Tutorial</button>
    <button onclick="toggleInstructions()">Show Detailed Rules</button>
  </div>
  
  <!-- Detailed Instructions Panel -->
  <div id="instructions">
    <h3>Detailed Rules & Strategies for Forty‑Fives</h3>
    <p>
      <strong>Overview:</strong><br>
      Forty‑Fives is a fun card game where you try to win tricks and score points. You and the computer bid on how many points you can win, then play cards each trick. Follow the suit if you can, and remember that trump cards (the suit chosen by the winner of the bid) beat other cards!
    </p>
    <p>
      <strong>Important Points:</strong><br>
      - Each trick is worth 5 points.<br>
      - The bonus trick gives you 5 extra points.<br>
      - If you win the bid, you must meet or beat your bid or lose that many points.<br>
      - The game continues until someone reaches 120 points.
    </p>
    <p>
      The computer will guide you through example hands and explain why it makes its moves in simple words.
    </p>
    <button onclick="toggleInstructions()">Hide Detailed Rules</button>
  </div>
  
  <!-- Main Game Container -->
  <div class="container" id="game-container" style="display:none;">
    <!-- Logo -->
    <div id="logo">45</div>
    <!-- Dealer and Trump Display -->
    <div id="dealer-info"></div>
    <div id="dealer-indicator"></div>
    <div id="trump-display"></div>
    
    <!-- Bidding Phase -->
    <div id="bidding-section" class="section">
      <h2>Bidding Phase</h2>
      <div id="competitor-bid"></div>
      <div>Your Hand:</div>
      <div id="player-hand-bidding" class="cards-container"></div>
      <div id="bid-options">
        <button onclick="placeBid(0)">Pass</button>
        <button onclick="placeBid(15)">Bid 15</button>
        <button onclick="placeBid(20)">Bid 20</button>
        <button onclick="placeBid(25)">Bid 25</button>
        <button onclick="placeBid(30)">Bid 30</button>
      </div>
      <div id="bidding-message"></div>
    </div>
    
    <!-- Trump Selection Phase -->
    <div id="trump-section" class="section hidden">
      <h2>Trump Selection</h2>
      <div id="trump-buttons" class="cards-container">
        <button onclick="selectTrump('♠')">♠</button>
        <button onclick="selectTrump('♥')">♥</button>
        <button onclick="selectTrump('♦')">♦</button>
        <button onclick="selectTrump('♣')">♣</button>
      </div>
    </div>
    
    <!-- Kitty Phase -->
    <div id="kitty-section" class="section hidden">
      <h2>Kitty Phase</h2>
      <div>Your Combined Hand (Your 5 cards + Kitty):</div>
      <div id="combined-hand" class="cards-container"></div>
      <div id="kitty-instructions">
        Click the cards you want to keep (up to 5 cards).
      </div>
      <button onclick="confirmKitty()">Confirm Selection</button>
    </div>
    
    <!-- Draw Phase -->
    <div id="draw-section" class="section hidden">
      <h2>Draw Phase</h2>
      <div id="draw-hand" class="cards-container"></div>
      <div id="draw-phase-instructions"></div>
      <button onclick="confirmDraw()">Draw Cards</button>
    </div>
    
    <!-- Trick Play Phase -->
    <div id="trick-section" class="section hidden">
      <h2>Trick Play</h2>
      <div id="trick-info"></div>
      <div>Your Hand:</div>
      <div id="player-hand-trick" class="cards-container"></div>
      <div>Trick Area:</div>
      <div id="trick-area" class="cards-container"></div>
      <div id="trick-log"></div>
    </div>
    
    <!-- Result Section -->
    <div id="result-section" class="section hidden">
      <h2>Game Over</h2>
      <div id="result-message"></div>
      <button onclick="resetGame()">Play Again</button>
    </div>
    
    <!-- Scoreboard Section -->
    <div id="scoreboard-section" class="section">
      <h2>Scoreboard</h2>
      <div id="scoreboard"></div>
    </div>
    
    <!-- Feedback Area -->
    <div id="feedback"></div>
  </div>
  
  <script>
    /***** Global Variables *****/
    let gameState = {};  // Current game state from the server

    // ----------------------------
    // Tutorial Modal Functions
    // ----------------------------
    function openTutorial() {
      document.getElementById("tutorial-modal").style.display = "flex";
    }
    function closeTutorial() {
      document.getElementById("tutorial-modal").style.display = "none";
    }

    // ----------------------------
    // UI Update Function
    // ----------------------------
    function updateUI(state) {
      gameState = state;
      document.getElementById('trump-display').textContent =
        state.trumpSuit ? "Trump Suit: " + state.trumpSuit : "";
      document.getElementById('bidding-message').textContent =
        state.biddingMessage || "";

      // Hide all phase sections
      ["bidding-section", "trump-section", "kitty-section", "draw-section", "trick-section", "result-section"]
        .forEach(id => document.getElementById(id).classList.add("hidden"));

      if(state.gamePhase === "bidding") {
        document.getElementById('bidding-section').classList.remove("hidden");
        let container = document.getElementById('player-hand-bidding');
        container.innerHTML = "";
        state.playerHand.forEach(card => {
          let div = document.createElement('div');
          div.className = 'card';
          div.textContent = card.rank + card.suit;
          container.appendChild(div);
        });
      } else if(state.gamePhase === "trump") {
        document.getElementById('trump-section').classList.remove("hidden");
      } else if(state.gamePhase === "kitty") {
        document.getElementById('kitty-section').classList.remove("hidden");
        let container = document.getElementById('combined-hand');
        container.innerHTML = "";
        state.combinedHand.forEach((card, index) => {
          let div = document.createElement('div');
          div.className = 'card';
          div.textContent = card.rank + card.suit;
          div.dataset.index = index;
          div.onclick = () => div.classList.toggle('selected');
          container.appendChild(div);
        });
      } else if(state.gamePhase === "draw") {
        document.getElementById('draw-section').classList.remove("hidden");
        let container = document.getElementById('draw-hand');
        container.innerHTML = "";
        state.drawHand.forEach(card => {
          let div = document.createElement('div');
          div.className = 'card';
          div.textContent = card.rank + card.suit;
          container.appendChild(div);
        });
        document.getElementById('draw-phase-instructions').textContent =
          state.drawInstructions || "";
      } else if(state.gamePhase === "trick") {
        document.getElementById('trick-section').classList.remove("hidden");
        let handContainer = document.getElementById('player-hand-trick');
        handContainer.innerHTML = "";
        state.playerHand.forEach((card, index) => {
          let div = document.createElement('div');
          div.className = 'card';
          div.textContent = card.rank + card.suit;
          if(state.currentTurn === "player") {
            div.onclick = () => playCard(index);
          }
          handContainer.appendChild(div);
        });
        let trickArea = document.getElementById('trick-area');
        trickArea.innerHTML = "";
        state.trickCards.forEach(entry => {
          let div = document.createElement('div');
          div.className = 'card';
          div.textContent = entry.card.rank + entry.card.suit;
          trickArea.appendChild(div);
        });
        document.getElementById('trick-info').textContent = state.trickInfo || "";
        let trickLog = document.getElementById('trick-log');
        trickLog.innerHTML = "";
        (state.trickLog || []).forEach(msg => {
          let p = document.createElement('div');
          p.textContent = msg;
          trickLog.appendChild(p);
        });
      } else if(state.gamePhase === "finished") {
        document.getElementById('result-section').classList.remove("hidden");
        document.getElementById('result-message').textContent = state.scoreboard || "";
      }
      document.getElementById('scoreboard').textContent = state.scoreboard || "";
      document.getElementById('feedback').textContent = state.feedback || "";
    }

    // ----------------------------
    // Helper API Call Function
    // ----------------------------
    async function callAPI(endpoint, method = "POST", data = {}) {
      try {
        let response = await fetch(endpoint, {
          method: method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        let result = await response.json();
        updateUI(result);
      } catch(err) {
        console.error("API call error:", err);
      }
    }

    // ----------------------------
    // Game Control Functions
    // ----------------------------
    function startGame() {
      let mode = document.getElementById('mode-select').value;
      let instructional = document.getElementById('instruction-mode').checked;
      document.getElementById('game-options').style.display = "none";
      document.getElementById('game-container').style.display = "block";
      callAPI("/start_game", "POST", { mode: mode, instructional: instructional });
    }

    function placeBid(bid) {
      callAPI("/bid", "POST", { bid: bid });
    }

    function selectTrump(suit) {
      callAPI("/select_trump", "POST", { trump: suit });
    }

    function confirmKitty() {
      let container = document.getElementById('combined-hand');
      let selectedDivs = container.querySelectorAll('.selected');
      let indices = [];
      selectedDivs.forEach(div => indices.push(parseInt(div.dataset.index)));
      callAPI("/confirm_kitty", "POST", { keptIndices: indices });
    }

    function confirmDraw() {
      callAPI("/confirm_draw", "POST", {});
    }

    function playCard(cardIndex) {
      callAPI("/play_trick", "POST", { cardIndex: cardIndex });
    }

    function resetGame() {
      callAPI("/reset_game", "POST", {});
    }

    function toggleInstructions() {
      let instrDiv = document.getElementById('instructions');
      instrDiv.style.display = (instrDiv.style.display === "none" || instrDiv.style.display === "") ? "block" : "none";
    }
  </script>
</body>
</html>
