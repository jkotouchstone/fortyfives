<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>45's Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Simulate green felt table */
    body {
      font-family: sans-serif;
      background-color: #35654d;
      margin: 0;
      padding: 20px;
      text-align: center;
      color: #fff;
    }
    .container {
      position: relative;
      max-width: 900px;
      margin: auto;
      background: rgba(0,0,0,0.7);
      padding: 20px;
      border-radius: 8px;
    }
    /* Game Options and Instructions Panels */
    #game-options, #instructions {
      max-width: 900px;
      margin: 20px auto;
      background: rgba(255,255,255,0.1);
      padding: 10px;
      border-radius: 8px;
    }
    #instructions {
      text-align: left;
      font-size: 14px;
      display: none;
    }
    /* Dealer Indicator */
    .dealer-indicator {
      display: inline-block;
      background: white;
      color: black;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      line-height: 50px;
      text-align: center;
      font-weight: bold;
      margin-left: 10px;
    }
    /* Logo */
    #logo {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 48px;
      font-weight: bold;
      opacity: 0.5;
      pointer-events: none;
    }
    .section { margin: 20px 0; }
    .hidden { display: none; }
    .cards-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
    .card {
      display: inline-block;
      width: 60px;
      height: 90px;
      border: 1px solid #333;
      border-radius: 5px;
      line-height: 90px;
      margin: 5px;
      cursor: pointer;
      user-select: none;
      background-color: #fff;
      color: #000;
    }
    .card.selected { background: #ffeb3b; }
    button {
      padding: 10px 15px;
      margin: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    /* Display Areas */
    #trump-display { font-weight: bold; margin-bottom: 10px; }
    #dealer-info { margin-bottom: 10px; }
    #competitor-bid { font-size: 16px; font-weight: bold; margin-bottom: 5px; color: #ffeb3b; }
    #competitor-hand-info { font-size: 14px; margin-top: 5px; color: #ffeb3b; }
    #trick-log {
      margin-top: 10px;
      text-align: left;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      background: #fafafa;
      padding: 10px;
      border: 1px solid #ccc;
      font-size: 14px;
      max-height: 150px;
      overflow-y: auto;
      color: #000;
    }
    #scoreboard-section {
      border-top: 2px solid #ffeb3b;
      padding-top: 10px;
    }
    #draw-phase-instructions { margin-top: 10px; font-style: italic; }
    #feedback {
      background: rgba(255,255,255,0.2);
      padding: 10px;
      border-radius: 5px;
      margin: 10px auto;
      max-width: 800px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <!-- Game Options Panel -->
  <div id="game-options">
    <h2>Game Options</h2>
    <label for="mode-select">Select Game Mode:</label>
    <select id="mode-select">
      <option value="2p">2-Player (You vs. Computer)</option>
      <option value="3p">3-Player (You vs. Two Computers)</option>
    </select>
    <label>
      <input type="checkbox" id="instruction-mode"> Instruction Mode
    </label>
    <button onclick="startGame()">Start Game</button>
    <button onclick="toggleInstructions()">Show Instructions</button>
  </div>
  
  <!-- Instructions Panel -->
  <div id="instructions">
    <h3>How to Play 45's</h3>
    <p>
      45's is a trick-taking card game with unique trump and off‑suit rankings.
      <br><br>
      <strong>Bidding:</strong> Your bid is based on “top cards” in your hand.
      In 2‑player mode, a lone 5 forces a bid of 20 and other key cards help determine your bid.
      In 3‑player mode, bidding is more challenging because three hands are in play.
      <br><br>
      <strong>Trump:</strong> The trump suit is determined by the winning bidder.
      (The trump suit is only displayed after trump selection.)
      <br><br>
      <strong>Trick Play:</strong> Each trick, every player plays one card.
      The highest trump wins the trick; if no trump is played, the highest card of the lead suit wins.
      <br><br>
      <strong>Dealer:</strong> The dealer rotates among players.
      In 2‑player mode a white “Dealer” badge is shown if you are the dealer.
      In 3‑player mode the scoreboard indicates which player is the dealer.
      <br><br>
      <strong>Instruction Mode:</strong> When enabled, you’ll receive extra feedback comparing your move to an optimal strategy.
      <br><br>
      Enjoy learning and playing 45's!
    </p>
    <button onclick="toggleInstructions()">Hide Instructions</button>
  </div>
  
  <!-- Main Game Container -->
  <div class="container" id="game-container" style="display:none;">
    <!-- Logo -->
    <div id="logo">45</div>
    <!-- Dealer and Trump Display -->
    <div id="dealer-info"></div>
    <div id="dealer-indicator"></div>
    <div id="trump-display"></div>
    
    <!-- Bidding Phase -->
    <div id="bidding-section" class="section">
      <h2>Bidding Phase</h2>
      <div id="competitor-bid"></div>
      <div>Your Hand (Deal):</div>
      <div id="player-hand-bidding" class="cards-container"></div>
      <div id="bid-options">
        <button onclick="placeBid(0)">Pass</button>
        <button onclick="placeBid(15)">Bid 15</button>
        <button onclick="placeBid(20)">Bid 20</button>
        <button onclick="placeBid(25)">Bid 25</button>
        <button onclick="placeBid(30)">Bid 30</button>
      </div>
      <div id="bidding-message"></div>
    </div>
    
    <!-- Trump Selection Phase -->
    <div id="trump-section" class="section hidden">
      <h2>Trump Selection</h2>
      <div id="trump-instructions"></div>
      <div id="trump-buttons" class="cards-container">
        <button onclick="selectTrump('♠')">♠</button>
        <button onclick="selectTrump('♥')">♥</button>
        <button onclick="selectTrump('♦')">♦</button>
        <button onclick="selectTrump('♣')">♣</button>
      </div>
      <div id="trump-selection-hand" class="cards-container"></div>
    </div>
    
    <!-- Kitty Phase -->
    <div id="kitty-section" class="section hidden">
      <h2>Kitty Phase</h2>
      <div>Your Combined Hand (Your 5 cards + Kitty):</div>
      <div id="combined-hand" class="cards-container"></div>
      <div id="kitty-instructions">
        Select up to 5 cards to keep from your 8‑card hand.
      </div>
      <button onclick="confirmKittySelection()">Confirm Selection</button>
    </div>
    
    <!-- Draw Phase -->
    <div id="draw-section" class="section hidden">
      <h2>Draw Phase</h2>
      <div id="draw-hand" class="cards-container"></div>
      <div id="draw-phase-instructions"></div>
      <div id="competitor-hand-info"></div>
      <button id="draw-button" onclick="confirmDraw()">Draw Cards</button>
    </div>
    
    <!-- Trick Play Phase -->
    <div id="trick-section" class="section hidden">
      <h2>Trick Play</h2>
      <div id="trick-info"></div>
      <div>Your Hand:</div>
      <div id="player-hand-trick" class="cards-container"></div>
      <div>Trick Area:</div>
      <div id="trick-area" class="cards-container"></div>
      <div id="trick-log"></div>
    </div>
    
    <!-- Result Section -->
    <div id="result-section" class="section hidden">
      <h2>Game Over</h2>
      <div id="result-message"></div>
      <button onclick="resetGame()">Play Again</button>
    </div>
    
    <!-- Scoreboard Section -->
    <div id="scoreboard-section" class="section">
      <h2>Scoreboard</h2>
      <div id="scoreboard"></div>
      <div id="hand-log"></div>
    </div>
    
    <!-- Feedback Area -->
    <div id="feedback"></div>
  </div>
  
  <script>
    /***** Global Variables and Settings *****/
    // Cumulative scores and hand log
    let cumulativePlayerScore = 0;
    let cumulativeCompetitorScore = 0;
    let cumulativeSecondComputerScore = 0;
    let handLogMessages = [];
    
    // Competitor names – in 2p mode we use one competitor; in 3p mode, we use two.
    let competitorName = "";
    let competitorName1 = "";
    let competitorName2 = "";
    let competitorDrawCount = 0; // (For 2p, used for the single competitor.)
    let difficulty = "hard"; // 'hard' or 'easy'
    
    // Mode settings
    let selectedMode = "2p"; // "2p" or "3p"
    let instructionalMode = false;
    
    /***** Game State Variables *****/
    let gamePhase = "bidding"; // "bidding", "trump", "kitty", "draw", "trick", "finished"
    let deck = [];
    let playerHand = [];
    let competitorHand = [];      // For 2p mode OR competitor 1 in 3p mode
    let secondComputerHand = [];  // For competitor 2 in 3p mode
    let kitty = [];
    let trumpSuit = null;
    let playerBid = 0;
    let competitorBid1 = 0;
    let competitorBid2 = 0;
    let winningBidder = null; // "player", "comp1", or "comp2"
    let playerTricks = 0;
    let competitorTricks1 = 0;
    let competitorTricks2 = 0;
    let trickCards = []; // Array of { card, player } – where player is "player", "comp1", or "comp2"
    let handPlayedCards = [];
    let trickNumber = 1;
    let trickTurn = null; // "player", "comp1", or "comp2"
    let playerCardPlayed = false;
    
    // Dealer – in 2p mode a boolean; in 3p mode, a string ("player", "comp1", or "comp2")
    let isPlayerDealer = true;  // For 2p mode
    let dealer = null;          // For 3p mode
    
    const suits = ['♠', '♥', '♦', '♣'];
    const ranks = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
    
    /***** Utility Functions *****/
    function createDeck() {
      let newDeck = [];
      for (let suit of suits) {
        for (let rank of ranks) {
          let value = (rank === 'A') ? 14 :
                      (rank === 'K') ? 13 :
                      (rank === 'Q') ? 12 :
                      (rank === 'J') ? 11 : parseInt(rank);
          newDeck.push({ suit, rank, value });
        }
      }
      console.log("Deck created with", newDeck.length, "cards.");
      return newDeck;
    }
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }
    // Only show trump suit after trump selection (not during bidding)
    function updateTrumpDisplay() {
      const display = document.getElementById('trump-display');
      if (gamePhase === "bidding") {
        display.textContent = "";
      } else {
        display.textContent = trumpSuit ? "Trump Suit: " + trumpSuit : "";
      }
    }
    function updateDealerInfo() {
      const dealerIndicator = document.getElementById('dealer-indicator');
      if (selectedMode === "2p") {
        if (isPlayerDealer) {
          dealerIndicator.innerHTML = '<div class="dealer-indicator">Dealer</div>';
        } else {
          dealerIndicator.innerHTML = "";
        }
      } else if (selectedMode === "3p") {
        dealerIndicator.innerHTML = "";
      }
    }
    function updateScoreboard() {
      const scoreboard = document.getElementById('scoreboard');
      let scoreText = "";
      if (selectedMode === "2p") {
        scoreText = "You" + (isPlayerDealer ? " [Dealer]" : "") + ": " + cumulativePlayerScore +
                    " | " + competitorName + (isPlayerDealer ? "" : " [Dealer]") + ": " + cumulativeCompetitorScore;
      } else if (selectedMode === "3p") {
        scoreText = "You" + (dealer === "player" ? " [Dealer]" : "") + ": " + cumulativePlayerScore +
                    " | " + competitorName1 + (dealer === "comp1" ? " [Dealer]" : "") + ": " + cumulativeCompetitorScore +
                    " | " + competitorName2 + (dealer === "comp2" ? " [Dealer]" : "") + ": " + cumulativeSecondComputerScore;
      }
      scoreboard.textContent = scoreText;
      
      const handLogDiv = document.getElementById('hand-log');
      handLogDiv.innerHTML = handLogMessages.map(msg => "<div>" + msg + "</div>").join("");
    }
    
    /***** Trump/Off‑Suit Logic *****/
    function isTrump(card) {
      return card.suit === trumpSuit || (card.suit === "♥" && card.rank === "A");
    }
    function getTrumpRank(card) {
      let order;
      if (trumpSuit === "♥") {
        order = ["5", "J", "A", "K", "Q", "10", "9", "8", "7", "6", "4", "3", "2"];
        return order.indexOf(card.rank);
      } else if (trumpSuit === "♦") {
        order = ["5", "J", "AH", "A", "K", "Q", "10", "9", "8", "7", "6", "4", "3", "2"];
        let r = card.rank;
        if (card.suit === "♥" && card.rank === "A") r = "AH";
        return order.indexOf(r);
      } else if (trumpSuit === "♣") {
        order = ["5", "J", "AH", "A", "K", "Q", "2", "3", "4", "6", "7", "8", "9", "10"];
        let r = card.rank;
        if (card.suit === "♥" && card.rank === "A") r = "AH";
        return order.indexOf(r);
      } else if (trumpSuit === "♠") {
        order = ["5", "J", "AH", "A", "K", "Q", "2", "3", "4", "6", "7", "8", "9", "10"];
        let r = card.rank;
        if (card.suit === "♥" && card.rank === "A") r = "AH";
        return order.indexOf(r);
      }
      return -1;
    }
    function getOffSuitRank(card) {
      let order;
      if (card.suit === "♥") {
        order = ["K", "Q", "J", "10", "9", "8", "7", "6", "5", "4", "3", "2"];
      } else if (card.suit === "♦") {
        order = ["K", "Q", "J", "10", "9", "8", "7", "6", "5", "4", "3", "2", "A"];
      } else if (card.suit === "♣") {
        order = ["K", "Q", "J", "A", "2", "3", "4", "5", "6", "7", "8", "9", "10"];
      } else if (card.suit === "♠") {
        order = ["K", "Q", "J", "A", "2", "3", "4", "5", "6", "7", "8", "9", "10"];
      }
      return order.indexOf(card.rank);
    }
    
    /***** Initial Deal *****/
    function dealCards() {
      // Clear trump suit from previous hand.
      trumpSuit = null;
      updateTrumpDisplay();
      
      deck = createDeck();
      shuffle(deck);
      
      if (selectedMode === "2p") {
        if (typeof isPlayerDealer === 'undefined') {
          isPlayerDealer = Math.random() < 0.5;
        }
        competitorName = competitorNames[Math.floor(Math.random() * competitorNames.length)];
      } else if (selectedMode === "3p") {
        if (!dealer) { dealer = "player"; }
        competitorName1 = competitorNames[Math.floor(Math.random() * competitorNames.length)];
        competitorName2 = competitorNames[Math.floor(Math.random() * competitorNames.length)];
      }
      
      updateDealerInfo();
      updateScoreboard();
      
      // Deal 5 cards to the human player.
      playerHand = deck.splice(0, 5);
      playerHand.forEach(card => card.original = true);
      
      // In 2p mode, deal 5 cards to competitorHand.
      competitorHand = deck.splice(0, 5);
      competitorHand.forEach(card => card.original = true);
      
      // In 3p mode, deal 5 cards to both computer opponents.
      if (selectedMode === "3p") {
        secondComputerHand = deck.splice(0, 5);
        secondComputerHand.forEach(card => card.original = true);
      }
      
      // Kitty gets 3 cards.
      kitty = deck.splice(0, 3);
      updateBiddingUI();
      
      // Bidding logic:
      if (selectedMode === "2p") {
        if (isPlayerDealer) {
          competitorBid1 = computeCompetitorBid(competitorHand);
          if (competitorBid1 === 0) {
            document.getElementById('bidding-message').textContent = "Bagged! You must bid 15 and choose trump.";
            winningBidder = "player";
            playerBid = 15;
            setTimeout(() => { nextBiddingPhase(); }, 1500);
          } else {
            document.getElementById('competitor-bid').textContent = competitorName + " bids: " + competitorBid1;
          }
        } else {
          playerBid = 15; // For simplicity, if you're not the dealer, you bid 15.
          competitorBid1 = (Math.random() < 0.5) ? 0 : 15;
          document.getElementById('competitor-bid').textContent = "";
          winningBidder = "player";
        }
      } else {
        let bidPlayer = 15; // For example, assume the human bids 15.
        let bidComp1 = computeCompetitorBid(competitorHand);
        let bidComp2 = computeCompetitorBid(secondComputerHand);
        if (bidPlayer >= bidComp1 && bidPlayer >= bidComp2) {
          winningBidder = "player";
          playerBid = bidPlayer;
          document.getElementById('bidding-message').textContent = "You win the bid (" + bidPlayer + " vs. " + bidComp1 + " vs. " + bidComp2 + ").";
        } else if (bidComp1 >= bidPlayer && bidComp1 >= bidComp2) {
          winningBidder = "comp1";
          competitorBid1 = bidComp1;
          document.getElementById('bidding-message').textContent = competitorName1 + " wins the bid (" + bidComp1 + " vs. " + bidPlayer + " vs. " + bidComp2 + ").";
        } else {
          winningBidder = "comp2";
          competitorBid2 = bidComp2;
          document.getElementById('bidding-message').textContent = competitorName2 + " wins the bid (" + bidComp2 + " vs. " + bidPlayer + " vs. " + bidComp1 + ").";
        }
        document.getElementById('competitor-bid').textContent = competitorName1 + " bids: " + bidComp1 + " | " + competitorName2 + " bids: " + bidComp2;
      }
      
      console.log("Player hand:", playerHand);
    }
    
    // computeCompetitorBid now accepts a hand.
    function computeCompetitorBid(hand) {
      let has5 = hand.some(card => card.rank === "5");
      let hasJack = hand.some(card => card.rank === "J");
      let hasAceHearts = hand.some(card => card.rank === "A" && card.suit === "♥");
      let hasNonHeartAce = hand.some(card => card.rank === "A" && card.suit !== "♥");
      let hasKing = hand.some(card => card.rank === "K");
      
      let topCount = 0;
      if (hasJack) topCount++;
      if (hasAceHearts) topCount++;
      if (hasNonHeartAce) topCount++;
      if (hasKing) topCount++;
      
      let bidValue;
      if (has5) {
        bidValue = 20;
      } else if (topCount >= 2) {
        bidValue = 20;
      } else if (topCount === 1) {
        bidValue = 15;
      } else {
        bidValue = 0;
      }
      
      let suitCounts = { "♠": 0, "♥": 0, "♦": 0, "♣": 0 };
      hand.forEach(card => {
        suitCounts[card.suit] = (suitCounts[card.suit] || 0) + 1;
      });
      let bestSuit = "♠";
      let maxCount = 0;
      for (let suit in suitCounts) {
        if (suitCounts[suit] > maxCount) {
          maxCount = suitCounts[suit];
          bestSuit = suit;
        }
      }
      trumpSuit = bestSuit;
      updateTrumpDisplay();
      
      return bidValue;
    }
    
    function updateBiddingUI() {
      const container = document.getElementById('player-hand-bidding');
      container.innerHTML = "";
      playerHand.forEach(card => {
        const div = document.createElement('div');
        div.className = 'card';
        div.textContent = card.rank + card.suit;
        container.appendChild(div);
      });
    }
    
    /***** Bidding Phase *****/
    function placeBid(bid) {
      if (selectedMode === "2p") {
        if (isPlayerDealer) {
          if (bid === 0) {
            winningBidder = "comp1";
            document.getElementById('bidding-message').textContent = "You passed. " + competitorName + " wins the bid.";
          } else if (bid > competitorBid1) {
            winningBidder = "player";
            document.getElementById('bidding-message').textContent = "You win the bid (" + bid + " vs. " + competitorBid1 + ").";
          } else {
            winningBidder = "comp1";
            document.getElementById('bidding-message').textContent = "Your bid is not higher; " + competitorName + " wins the bid.";
          }
          setTimeout(() => { nextBiddingPhase(); }, 1500);
        } else {
          playerBid = bid;
          competitorBid1 = (Math.random() < 0.5) ? 0 : 15;
          if (playerBid === 0 && competitorBid1 === 0) {
            winningBidder = "comp1";
            document.getElementById('bidding-message').textContent = "Both passed. " + competitorName + " wins the bid.";
          } else if (playerBid >= competitorBid1) {
            winningBidder = "player";
            document.getElementById('bidding-message').textContent = "You win the bid (" + playerBid + " vs. " + competitorBid1 + ").";
          } else {
            winningBidder = "comp1";
            document.getElementById('bidding-message').textContent = competitorName + " wins the bid (" + competitorBid1 + " vs. your bid " + playerBid + ").";
          }
          setTimeout(() => { nextBiddingPhase(); }, 1500);
        }
      } else {
        // 3p mode: assume human bid is the one clicked.
        let bidPlayer = bid;
        let bidComp1 = computeCompetitorBid(competitorHand);
        let bidComp2 = computeCompetitorBid(secondComputerHand);
        if (bidPlayer >= bidComp1 && bidPlayer >= bidComp2) {
          winningBidder = "player";
          playerBid = bidPlayer;
          document.getElementById('bidding-message').textContent = "You win the bid (" + bidPlayer + " vs. " + bidComp1 + " vs. " + bidComp2 + ").";
        } else if (bidComp1 >= bidPlayer && bidComp1 >= bidComp2) {
          winningBidder = "comp1";
          competitorBid1 = bidComp1;
          document.getElementById('bidding-message').textContent = competitorName1 + " wins the bid (" + bidComp1 + " vs. " + bidPlayer + " vs. " + bidComp2 + ").";
        } else {
          winningBidder = "comp2";
          competitorBid2 = bidComp2;
          document.getElementById('bidding-message').textContent = competitorName2 + " wins the bid (" + bidComp2 + " vs. " + bidPlayer + " vs. " + bidComp1 + ").";
        }
        document.getElementById('competitor-bid').textContent = competitorName1 + " bids: " + bidComp1 + " | " + competitorName2 + " bids: " + bidComp2;
        setTimeout(() => { nextBiddingPhase(); }, 1500);
      }
    }
    
    /***** Trump Selection Phase *****/
    function updateTrumpSelectionHand() {
      const container = document.getElementById('trump-selection-hand');
      container.innerHTML = "";
      playerHand.forEach(card => {
        const div = document.createElement('div');
        div.className = 'card';
        div.textContent = card.rank + card.suit;
        container.appendChild(div);
      });
    }
    function selectTrump(suit) {
      trumpSuit = suit;
      updateTrumpDisplay();
      if ((selectedMode === "2p" && winningBidder === "player") ||
          (selectedMode === "3p" && winningBidder === "player")) {
        setTimeout(() => {
          gamePhase = "kitty";
          updateSections();
          updateKittyPhase();
        }, 1500);
      }
    }
    function autoSelectTrump() {
      const randomSuit = suits[Math.floor(Math.random() * suits.length)];
      trumpSuit = randomSuit;
      updateTrumpDisplay();
      if (selectedMode === "2p") {
        competitorHand = competitorHand.concat(kitty);
        while (competitorHand.length > 5) {
          competitorHand.splice(Math.floor(Math.random() * competitorHand.length), 1);
        }
      } else {
        competitorHand = competitorHand.concat(kitty);
        while (competitorHand.length > 5) {
          competitorHand.splice(Math.floor(Math.random() * competitorHand.length), 1);
        }
      }
      gamePhase = "draw";
      updateSections();
      updateDrawPhase();
    }
    
    /***** Kitty Phase *****/
    function updateKittyPhase() {
      document.getElementById('trump-section').classList.add('hidden');
      document.getElementById('kitty-section').classList.remove('hidden');
      const combined = playerHand.concat(kitty);
      const container = document.getElementById('combined-hand');
      container.innerHTML = "";
      combined.forEach((card, index) => {
        const div = document.createElement('div');
        div.className = 'card';
        div.textContent = card.rank + card.suit;
        div.dataset.index = index;
        div.onclick = () => {
          if (div.classList.contains('selected')) {
            div.classList.remove('selected');
          } else {
            const selected = container.querySelectorAll('.selected');
            if (selected.length < 5) { div.classList.add('selected'); }
          }
        };
        container.appendChild(div);
      });
    }
    function confirmKittySelection() {
      const container = document.getElementById('combined-hand');
      const selectedDivs = container.querySelectorAll('.selected');
      let selectedCards = [];
      const combined = playerHand.concat(kitty);
      selectedDivs.forEach(div => {
        selectedCards.push(combined[parseInt(div.dataset.index)]);
      });
      if (selectedCards.length > 5) {
        alert("You can keep at most 5 cards.");
        return;
      }
      if (selectedCards.filter(c => c.original).length < 1) {
        alert("You must keep at least one card from your original deal.");
        return;
      }
      playerHand = selectedCards;
      gamePhase = "draw";
      updateSections();
      updateDrawPhase();
    }
    
    /***** Draw Phase *****/
    function updateDrawPhase() {
      document.getElementById('trump-section').classList.add('hidden');
      document.getElementById('draw-section').classList.remove('hidden');
      const container = document.getElementById('draw-hand');
      container.innerHTML = "";
      const instructions = document.getElementById('draw-phase-instructions');
      let needToDraw = 5 - playerHand.length;
      
      if ((selectedMode === "2p" && winningBidder === "player") ||
          (selectedMode === "3p" && winningBidder === "player")) {
        playerHand.forEach(card => {
          const div = document.createElement('div');
          div.className = 'card';
          div.textContent = card.rank + card.suit;
          container.appendChild(div);
        });
        container.style.pointerEvents = "none";
        instructions.textContent = needToDraw > 0 
          ? "You have kept " + playerHand.length + " cards. Click 'Draw Cards' to draw " + needToDraw + " card(s)."
          : "You have a full 5‑card hand. Click 'Draw Cards' to continue.";
      } else {
        container.style.pointerEvents = "auto";
        container.innerHTML = "";
        playerHand.forEach((card, index) => {
          const div = document.createElement('div');
          div.className = 'card';
          div.textContent = card.rank + card.suit;
          div.dataset.index = index;
          div.onclick = () => {
            if (div.classList.contains('selected')) {
              div.classList.remove('selected');
            } else {
              div.classList.add('selected');
            }
          };
          container.appendChild(div);
        });
        instructions.textContent = "Select the cards you want to keep from your hand. The rest will be replaced.";
      }
      updateCompetitorDrawInfo();
    }
    function updateCompetitorDrawInfo() {
      if (selectedMode === "2p") {
        competitorAutoDraw(competitorHand);
        document.getElementById('competitor-hand-info').textContent = competitorName + " drew " + competitorDrawCount + " card(s).";
      } else {
        competitorAutoDraw(competitorHand);
        let info1 = competitorName1 + " drew " + competitorDrawCount + " card(s).";
        competitorAutoDraw(secondComputerHand);
        let info2 = competitorName2 + " drew " + competitorDrawCount + " card(s).";
        document.getElementById('competitor-hand-info').textContent = info1 + " | " + info2;
      }
    }
    function confirmDraw() {
      if ((selectedMode === "2p" && winningBidder === "player") ||
          (selectedMode === "3p" && winningBidder === "player")) {
        let required = 5 - playerHand.length;
        for (let i = 0; i < required; i++) {
          if (deck.length > 0) { playerHand.push(deck.pop()); }
        }
      } else {
        const container = document.getElementById('draw-hand');
        const selectedDivs = container.querySelectorAll('.selected');
        let keptCards = [];
        if (selectedDivs.length === 0) {
          keptCards = playerHand;
        } else {
          selectedDivs.forEach(div => { keptCards.push(playerHand[parseInt(div.dataset.index)]); });
        }
        if (keptCards.filter(c => c.original).length < 1) {
          alert("You must keep at least one card from your original deal.");
          return;
        }
        playerHand = keptCards;
        let required = 5 - playerHand.length;
        for (let i = 0; i < required; i++) {
          if (deck.length > 0) { playerHand.push(deck.pop()); }
        }
      }
      startTrickPlay();
    }
    
    // Modified competitorAutoDraw to accept a hand parameter.
    function competitorAutoDraw(hand) {
      let kept = hand.filter(card => isTrump(card));
      if (kept.length < 1 && hand.length > 0) {
        kept.push(hand.reduce((a, b) => a.value > b.value ? a : b));
      }
      competitorDrawCount = 5 - kept.length;
      for (let i = 0; i < competitorDrawCount; i++) {
        if (deck.length > 0) { kept.push(deck.pop()); }
      }
      // Replace the contents of the hand.
      hand.length = 0;
      kept.forEach(card => hand.push(card));
    }
    
    /***** Trick Play Phase *****/
    // For 2p mode, orderOfPlay is ["player", "comp1"].
    // For 3p mode, orderOfPlay is determined by the winning bidder.
    let orderOfPlay = [];
    
    function startTrickPlay() {
      gamePhase = "trick";
      trickCards = [];
      handPlayedCards = [];
      trickNumber = 1;
      playerCardPlayed = false;
      if (selectedMode === "2p") {
        if (winningBidder === "player") {
          orderOfPlay = ["player", "comp1"];
        } else {
          orderOfPlay = ["comp1", "player"];
        }
        trickTurn = orderOfPlay[0];
      } else {
        if (winningBidder === "player") {
          orderOfPlay = ["player", "comp1", "comp2"];
        } else if (winningBidder === "comp1") {
          orderOfPlay = ["comp1", "comp2", "player"];
        } else {
          orderOfPlay = ["comp2", "player", "comp1"];
        }
        trickTurn = orderOfPlay[0];
      }
      
      if (trickTurn !== "player") {
        setTimeout(() => { computerPlayCard(trickTurn); }, 1000);
      } else {
        updateTrickUI();
      }
      
      document.getElementById('bidding-section').classList.add('hidden');
      document.getElementById('trump-section').classList.add('hidden');
      document.getElementById('kitty-section').classList.add('hidden');
      document.getElementById('draw-section').classList.add('hidden');
      document.getElementById('trick-section').classList.remove('hidden');
      document.getElementById('trick-log').innerHTML = "";
      updateTrickUI();
    }
    
    // For 2p mode, use computerPlayCard; for 3p mode, use computerPlayCard with the parameter.
    function computerPlayCard(comp) {
      let hand;
      if (comp === "comp1") {
        hand = competitorHand;
      } else if (comp === "comp2") {
        hand = secondComputerHand;
      }
      if (!hand || hand.length === 0) {
        continueTrick();
        return;
      }
      // For simplicity, choose a random card.
      let cardToPlay = hand[Math.floor(Math.random() * hand.length)];
      hand.splice(hand.indexOf(cardToPlay), 1);
      trickCards.push({ card: cardToPlay, player: comp });
      updateTrickArea();
      
      // Determine next player in order.
      let currentIndex = orderOfPlay.indexOf(comp);
      let nextIndex = (currentIndex + 1) % orderOfPlay.length;
      trickTurn = orderOfPlay[nextIndex];
      
      updateTrickUI();
      
      if (trickTurn !== "player") {
        setTimeout(() => { computerPlayCard(trickTurn); }, 500);
      }
    }
    
    function updateTrickUI() {
      const handDiv = document.getElementById('player-hand-trick');
      handDiv.innerHTML = "";
      playerHand.forEach((card, index) => {
        const div = document.createElement('div');
        div.className = 'card';
        div.textContent = card.rank + card.suit;
        div.dataset.index = index;
        if (trickTurn !== "player") {
          div.style.pointerEvents = "none";
        } else {
          div.onclick = () => {
            if (gamePhase === "trick" && trickTurn === "player") {
              if (playerCardPlayed) {
                alert("You have already played a card this trick!");
              } else {
                playPlayerCard(index);
              }
            }
          };
        }
        handDiv.appendChild(div);
      });
      updateTrickArea();
      document.getElementById('trick-info').textContent = "Trick " + trickNumber + " of 5. " +
          (trickTurn === "player" ? "Your turn to play a card." : trickTurn + " is playing.");
    }
    
    function updateTrickArea() {
      const trickDiv = document.getElementById('trick-area');
      trickDiv.innerHTML = "";
      trickCards.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'card';
        div.textContent = entry.card.rank + entry.card.suit;
        trickDiv.appendChild(div);
      });
    }
    
    function playPlayerCard(index) {
      if (gamePhase !== "trick" || trickTurn !== "player") return;
      if (playerCardPlayed) return;
      
      let chosenCard = playerHand.splice(index, 1)[0];
      trickCards.push({ card: chosenCard, player: "player" });
      playerCardPlayed = true;
      updateTrickArea();
      
      // Determine next turn.
      if (selectedMode === "2p") {
        trickTurn = orderOfPlay[1];
      } else {
        let currentIndex = orderOfPlay.indexOf("player");
        let nextIndex = (currentIndex + 1) % orderOfPlay.length;
        trickTurn = orderOfPlay[nextIndex];
      }
      continueTrick();
      
      if (instructionalMode) {
        document.getElementById('feedback').textContent = "Feedback: Compare your move with the optimal strategy.";
      }
    }
    
    function evaluateTrick() {
      if (selectedMode === "2p") {
        if (trickCards.length < 2) return;
      } else {
        if (trickCards.length < 3) return;
      }
      handPlayedCards.push(...trickCards);
      
      // Determine the trick winner.
      let ledSuit = trickCards[0].card.suit;
      let trumpPlays = trickCards.filter(e => isTrump(e.card));
      let winner;
      if (trumpPlays.length > 0) {
        winner = trumpPlays.reduce((best, curr) => (getTrumpRank(curr.card) < getTrumpRank(best.card)) ? curr : best);
      } else {
        let followPlays = trickCards.filter(e => e.card.suit === ledSuit);
        if (followPlays.length > 0) {
          winner = followPlays.reduce((best, curr) => (getOffSuitRank(curr.card) < getOffSuitRank(best.card)) ? curr : best);
        } else {
          winner = trickCards[0];
        }
      }
      
      // Award the trick.
      if (winner.player === "player") {
        playerTricks++;
      } else if (winner.player === "comp1") {
        competitorTricks1++;
      } else if (winner.player === "comp2") {
        competitorTricks2++;
      }
      
      let msg = "Trick " + trickNumber + ": ";
      msg += "Player played " + (trickCards.find(e => e.player === "player")?.card.rank + trickCards.find(e => e.player === "player")?.card.suit || "–") + ", ";
      if (selectedMode === "2p") {
        msg += competitorName + " played " + (trickCards.find(e => e.player === "comp1")?.card.rank + trickCards.find(e => e.player === "comp1")?.card.suit || "–");
      } else {
        msg += competitorName1 + " played " + (trickCards.find(e => e.player === "comp1")?.card.rank + trickCards.find(e => e.player === "comp1")?.card.suit || "–") + ", ";
        msg += competitorName2 + " played " + (trickCards.find(e => e.player === "comp2")?.card.rank + trickCards.find(e => e.player === "comp2")?.card.suit || "–");
      }
      msg += ". Winner: " + (winner.player === "player" ? "You" : (winner.player === "comp1" ? competitorName1 : competitorName2)) +
             " (" + winner.card.rank + winner.card.suit + ").";
      
      appendTrickLog(msg);
      trickCards = [];
      trickNumber++;
      playerCardPlayed = false;
      
      // If 5 tricks have been completed, end the hand.
      if (trickNumber > 5) {
        setTimeout(endHand, 3000);
      } else {
        // Determine next turn.
        let currentIndex = orderOfPlay.indexOf(winner.player);
        let nextIndex = (currentIndex + 1) % orderOfPlay.length;
        trickTurn = orderOfPlay[nextIndex];
        updateTrickUI();
        if (trickTurn !== "player") {
          setTimeout(() => { computerPlayCard(trickTurn); }, 500);
        }
      }
    }
    
    function appendTrickLog(message) {
      const logDiv = document.getElementById('trick-log');
      let p = document.createElement('div');
      p.textContent = message;
      logDiv.appendChild(p);
    }
    
    function continueTrick() {
      if (selectedMode === "2p") {
        if (trickCards.length === 2) {
          setTimeout(evaluateTrick, 500);
        }
      } else {
        if (trickCards.length === 3) {
          setTimeout(evaluateTrick, 500);
        } else if (trickCards.length < 3 && trickTurn !== "player") {
          setTimeout(() => { computerPlayCard(trickTurn); }, 500);
        }
      }
    }
    
    /***** End of Hand & Scoring *****/
    function endHand() {
      gamePhase = "finished";
      document.getElementById('trick-section').classList.add('hidden');
      
      // Simple bonus: add 5 points to the player with the most tricks.
      let bonusWinner = "player";
      if (selectedMode === "2p") {
        if (competitorTricks1 > playerTricks) bonusWinner = "comp1";
      } else {
        if (competitorTricks1 >= playerTricks && competitorTricks1 >= competitorTricks2) {
          bonusWinner = "comp1";
        } else if (competitorTricks2 >= playerTricks && competitorTricks2 >= competitorTricks1) {
          bonusWinner = "comp2";
        }
      }
      
      let playerPoints = playerTricks * 5;
      let comp1Points = competitorTricks1 * 5;
      let comp2Points = competitorTricks2 * 5;
      
      if (bonusWinner === "player") playerPoints += 5;
      else if (bonusWinner === "comp1") comp1Points += 5;
      else if (bonusWinner === "comp2") comp2Points += 5;
      
      if (selectedMode === "2p") {
        cumulativePlayerScore += playerPoints;
        cumulativeCompetitorScore += comp1Points;
      } else {
        cumulativePlayerScore += playerPoints;
        cumulativeCompetitorScore += comp1Points;
        cumulativeSecondComputerScore += comp2Points;
      }
      
      let handResult;
      if (selectedMode === "2p") {
        handResult = "Hand " + (++handNumber) + ": You won " + playerTricks + " tricks (" + (playerTricks * 5) +
                     (bonusWinner === "player" ? " + Bonus (5)" : "") +
                     "); " + competitorName + " won " + competitorTricks1 + " tricks (" + (competitorTricks1 * 5) +
                     (bonusWinner === "comp1" ? " + Bonus (5)" : "") +
                     "). Round Total: You " + playerPoints + " vs. " + competitorName + " " + comp1Points + ".";
      } else {
        handResult = "Hand " + (++handNumber) + ": You won " + playerTricks + " tricks (" + (playerTricks * 5) +
                     (bonusWinner === "player" ? " + Bonus (5)" : "") +
                     "; " + competitorName1 + " won " + competitorTricks1 + " tricks (" + (competitorTricks1 * 5) +
                     (bonusWinner === "comp1" ? " + Bonus (5)" : "") +
                     "; " + competitorName2 + " won " + competitorTricks2 + " tricks (" + (competitorTricks2 * 5) +
                     (bonusWinner === "comp2" ? " + Bonus (5)" : "") +
                     "). Round Totals: You " + playerPoints + " vs. " + competitorName1 + " " + comp1Points +
                     " vs. " + competitorName2 + " " + comp2Points + ".";
      }
      
      handLogMessages.push(handResult);
      updateScoreboard();
      
      // End the game if any score exceeds 120.
      if ((selectedMode === "2p" && (cumulativePlayerScore >= 120 || cumulativeCompetitorScore >= 120)) ||
          (selectedMode === "3p" && (cumulativePlayerScore >= 120 || cumulativeCompetitorScore >= 120 || cumulativeSecondComputerScore >= 120))) {
        let winner;
        if (selectedMode === "2p") {
          winner = cumulativePlayerScore >= 120 ? "You" : competitorName;
        } else {
          // For 3p mode, simply state "Game Over"
          winner = "Game Over";
        }
        document.getElementById('result-message').textContent = "Game Over! " + winner + " win the game.\n" + handResult;
        document.getElementById('result-section').classList.remove('hidden');
      } else {
        setTimeout(nextHand, 3000);
      }
    }
    
    function nextHand() {
      if (selectedMode === "2p") {
        isPlayerDealer = !isPlayerDealer;
      } else {
        if (dealer === "player") {
          dealer = "comp1";
        } else if (dealer === "comp1") {
          dealer = "comp2";
        } else {
          dealer = "player";
        }
      }
      updateDealerInfo();
      playerTricks = 0;
      competitorTricks1 = 0;
      competitorTricks2 = 0;
      trickCards = [];
      handPlayedCards = [];
      trickNumber = 1;
      trumpSuit = null;
      updateTrumpDisplay();
      playerBid = 0;
      competitorBid1 = 0;
      competitorBid2 = 0;
      winningBidder = null;
      document.getElementById('bidding-message').textContent = "";
      document.getElementById('competitor-bid').textContent = "";
      gamePhase = "bidding";
      updateSections();
      dealCards();
    }
    
    function resetGame() {
      cumulativePlayerScore = 0;
      cumulativeCompetitorScore = 0;
      cumulativeSecondComputerScore = 0;
      handLogMessages = [];
      handNumber = 0;
      competitorName = "";
      competitorName1 = "";
      competitorName2 = "";
      updateScoreboard();
      resetHandState();
      gamePhase = "bidding";
      trumpSuit = null;
      updateTrumpDisplay();
      updateSections();
      document.getElementById('result-section').classList.add('hidden');
      dealCards();
    }
    
    function resetHandState() {
      playerTricks = 0;
      competitorTricks1 = 0;
      competitorTricks2 = 0;
      trickCards = [];
      handPlayedCards = [];
      trickNumber = 1;
      trumpSuit = null;
      playerBid = 0;
      competitorBid1 = 0;
      competitorBid2 = 0;
      winningBidder = null;
    }
    
    /***** Section Visibility Control *****/
    function updateSections() {
      document.getElementById('bidding-section').classList.add('hidden');
      document.getElementById('trump-section').classList.add('hidden');
      document.getElementById('kitty-section').classList.add('hidden');
      document.getElementById('draw-section').classList.add('hidden');
      document.getElementById('trick-section').classList.add('hidden');
      
      if (gamePhase === "bidding") {
        document.getElementById('bidding-section').classList.remove('hidden');
        updateBiddingUI();
      } else if (gamePhase === "trump") {
        document.getElementById('trump-section').classList.remove('hidden');
      } else if (gamePhase === "kitty") {
        document.getElementById('kitty-section').classList.remove('hidden');
      } else if (gamePhase === "draw") {
        document.getElementById('draw-section').classList.remove('hidden');
      } else if (gamePhase === "trick") {
        document.getElementById('trick-section').classList.remove('hidden');
      }
      updateTrumpDisplay();
    }
    
    /***** Game Options & Instruction Functions *****/
    function startGame() {
      selectedMode = document.getElementById('mode-select').value;
      instructionalMode = document.getElementById('instruction-mode').checked;
      document.getElementById('game-options').style.display = "none";
      document.getElementById('game-container').style.display = "block";
      document.getElementById('feedback').textContent = "";
      if (selectedMode === "2p") {
        isPlayerDealer = Math.random() < 0.5;
      } else {
        dealer = "player";
      }
      updateDealerInfo();
      updateScoreboard();
      dealCards();
    }
    
    function toggleInstructions() {
      let instrDiv = document.getElementById('instructions');
      if (instrDiv.style.display === "none" || instrDiv.style.display === "") {
        instrDiv.style.display = "block";
      } else {
        instrDiv.style.display = "none";
      }
    }
    
    window.onload = function() {
      document.getElementById('game-options').style.display = "block";
      document.getElementById('game-container').style.display = "none";
    }
  </script>
</body>
</html>
