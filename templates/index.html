<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Forty‑Fives Game (Heads‑Up)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Basic styling – adjust later as needed */
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
    }
    .section { margin: 20px 0; }
    .hidden { display: none; }
    .cards-container {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
    .card {
      display: inline-block;
      width: 60px;
      height: 90px;
      border: 1px solid #333;
      border-radius: 5px;
      line-height: 90px;
      margin: 5px;
      cursor: pointer;
      user-select: none;
    }
    .card.selected { background: #ffeb3b; }
    button {
      padding: 10px 15px;
      margin: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    /* Display current trump suit and dealer info */
    #trump-display { font-weight: bold; margin-bottom: 10px; }
    #dealer-info { font-weight: bold; margin-bottom: 10px; color: #007; }
    /* Trick log area */
    #trick-log {
      margin-top: 10px;
      text-align: left;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      background: #fafafa;
      padding: 10px;
      border: 1px solid #ccc;
      font-size: 14px;
      max-height: 150px;
      overflow-y: auto;
    }
    /* Scoreboard section */
    #scoreboard-section {
      border-top: 2px solid #333;
      padding-top: 10px;
    }
    /* Draw Phase instructions */
    #draw-phase-instructions { margin-top: 10px; font-style: italic; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Dealer Indicator & Trump Display -->
    <div id="dealer-info"></div>
    <div id="trump-display"></div>
    
    <!-- Bidding Phase -->
    <div id="bidding-section" class="section">
      <h2>Bidding Phase</h2>
      <div>Your Hand (Deal):</div>
      <div id="player-hand-bidding" class="cards-container"></div>
      <div>
        <button onclick="placeBid(0)">Pass</button>
        <button onclick="placeBid(15)">Bid 15</button>
        <button onclick="placeBid(20)">Bid 20</button>
        <button onclick="placeBid(25)">Bid 25</button>
        <button onclick="placeBid(30)">Bid 30</button>
      </div>
      <div id="bidding-message"></div>
    </div>
    
    <!-- Trump Selection Phase -->
    <div id="trump-section" class="section hidden">
      <h2>Trump Selection</h2>
      <div id="trump-instructions"></div>
      <div id="trump-buttons" class="cards-container">
        <button onclick="selectTrump('♠')">♠</button>
        <button onclick="selectTrump('♥')">♥</button>
        <button onclick="selectTrump('♦')">♦</button>
        <button onclick="selectTrump('♣')">♣</button>
      </div>
    </div>
    
    <!-- Kitty Phase (for player win) -->
    <div id="kitty-section" class="section hidden">
      <h2>Kitty Phase</h2>
      <div>Your Combined Hand (Your 5 cards + Kitty):</div>
      <div id="combined-hand" class="cards-container"></div>
      <div id="kitty-instructions">
        Select up to 5 cards to keep from your 8‑card hand.
      </div>
      <button onclick="confirmKittySelection()">Confirm Selection</button>
    </div>
    
    <!-- Draw Phase (for both competitor win and player win) -->
    <div id="draw-section" class="section hidden">
      <h2>Draw Phase</h2>
      <div>Your Hand:</div>
      <div id="draw-hand" class="cards-container"></div>
      <div id="draw-phase-instructions"></div>
      <button onclick="confirmDraw()">Draw Cards</button>
    </div>
    
    <!-- Trick Play Phase -->
    <div id="trick-section" class="section hidden">
      <h2>Trick Play</h2>
      <div id="trick-info"></div>
      <div>Your Hand:</div>
      <div id="player-hand-trick" class="cards-container"></div>
      <div>Trick Area:</div>
      <div id="trick-area" class="cards-container"></div>
      <!-- Trick Log -->
      <div id="trick-log"></div>
    </div>
    
    <!-- Result Section (shown when a player reaches 120+ points) -->
    <div id="result-section" class="section hidden">
      <h2>Game Over</h2>
      <div id="result-message"></div>
      <button onclick="resetGame()">Play Again</button>
    </div>
    
    <!-- Scoreboard Section (always visible) -->
    <div id="scoreboard-section" class="section">
      <h2>Scoreboard</h2>
      <div id="scoreboard">You: 0 | Competitor: 0</div>
      <div id="hand-log"></div>
    </div>
  </div>
  
  <script>
    /***** Game State Variables *****/
    // Phases: "bidding", "trump", "kitty", "draw", "trick", "finished"
    let gamePhase = "bidding";
    let deck = [];
    let playerHand = [];
    let competitorHand = [];
    let kitty = [];
    let trumpSuit = null;
    let playerBid = 0;
    let competitorBid = 0;
    let bidWinner = null; // "player" or "competitor"
    let playerTricks = 0;
    let competitorTricks = 0;
    let trickCards = []; // Array of { card, player }
    let handPlayedCards = []; // All cards played (for bonus calculation)
    let trickNumber = 1;
    let trickTurn = null; // "player" or "competitor"
    
    // Cumulative scores and hand log
    let cumulativePlayerScore = 0;
    let cumulativeCompetitorScore = 0;
    let handNumber = 0;
    let handLogMessages = [];
    
    // Dealer flag – for the first hand, determined randomly; then rotates.
    let isPlayerDealer = undefined;
    
    const suits = ['♠', '♥', '♦', '♣'];
    const ranks = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
    
    /***** Utility Functions *****/
    function createDeck() {
      let newDeck = [];
      for (let suit of suits) {
        for (let rank of ranks) {
          let value = (rank === 'A') ? 14 :
                      (rank === 'K') ? 13 :
                      (rank === 'Q') ? 12 :
                      (rank === 'J') ? 11 : parseInt(rank);
          newDeck.push({ suit, rank, value });
        }
      }
      return newDeck;
    }
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }
    function updateTrumpDisplay() {
      const display = document.getElementById('trump-display');
      display.textContent = trumpSuit ? "Trump Suit: " + trumpSuit : "";
    }
    function updateDealerInfo() {
      const dealerDiv = document.getElementById('dealer-info');
      dealerDiv.textContent = isPlayerDealer ? "You are the DEALER" : "You are NOT the dealer";
    }
    function updateScoreboard() {
      const scoreboard = document.getElementById('scoreboard');
      scoreboard.textContent = "You: " + cumulativePlayerScore + " | Competitor: " + cumulativeCompetitorScore;
      const handLogDiv = document.getElementById('hand-log');
      handLogDiv.innerHTML = handLogMessages.map(msg => "<div>" + msg + "</div>").join("");
    }
    
    /***** Helper: isTrump *****/
    // Returns true if the card is considered trump.
    function isTrump(card) {
      // In this game, if trump is not hearts, the Ace of Hearts is still trump.
      return card.suit === trumpSuit || (card.suit === "♥" && card.rank === "A");
    }
    
    /***** Bonus Ranking Function *****/
    function getCardBonusRank(card) {
      // Only consider trump cards for bonus; if not trump, return -1.
      if (!isTrump(card)) return -1;
      let order;
      if (trumpSuit === "♥") {
        order = ["5", "J", "A", "K", "Q", "10", "9", "8", "7", "6", "4", "3", "2"];
      } else {
        order = ["5", "J", "A", "K", "Q", "2", "3", "4", "6", "7", "8", "9", "10"];
      }
      let index = order.indexOf(card.rank);
      if (index === -1) index = order.length;
      return order.length - index;
    }
    
    /***** Initial Deal (on page load) *****/
    function dealCards() {
      deck = createDeck();
      shuffle(deck);
      if (typeof isPlayerDealer === 'undefined') {
        isPlayerDealer = Math.random() < 0.5;
      }
      updateDealerInfo();
      // Deal 5 cards to each player in "3 then 2" order.
      playerHand = deck.splice(0, 3);
      competitorHand = deck.splice(0, 3);
      playerHand = playerHand.concat(deck.splice(0, 2));
      competitorHand = competitorHand.concat(deck.splice(0, 2));
      // Kitty gets 3 cards.
      kitty = deck.splice(0, 3);
      updateBiddingUI();
    }
    function updateBiddingUI() {
      const container = document.getElementById('player-hand-bidding');
      container.innerHTML = "";
      playerHand.forEach(card => {
        const div = document.createElement('div');
        div.className = 'card';
        div.textContent = card.rank + card.suit;
        container.appendChild(div);
      });
    }
    
    /***** Bidding Phase *****/
    function placeBid(bid) {
      if (isPlayerDealer && bid === 0) {
        bid = 15;
        document.getElementById('bidding-message').textContent = "As the dealer, you must bid at least 15.";
      }
      playerBid = bid;
      competitorBid = (Math.random() < 0.5) ? 0 : [15, 20, 25, 30][Math.floor(Math.random() * 4)];
      let message = "";
      if (playerBid === 0 && competitorBid === 0) {
        bidWinner = "competitor";
        message = "Both passed. Competitor wins the bid.";
      } else if (playerBid >= competitorBid) {
        bidWinner = "player";
        message = "You win the bid (" + playerBid + " vs. " + competitorBid + ").";
      } else {
        bidWinner = "competitor";
        message = "Competitor wins the bid (" + competitorBid + " vs. your bid " + playerBid + ").";
      }
      document.getElementById('bidding-message').textContent = message;
      setTimeout(() => {
        gamePhase = "trump";
        updateSections();
        if (bidWinner === "competitor") {
          document.getElementById('trump-instructions').textContent = "Competitor is selecting trump suit...";
          document.getElementById('trump-buttons').classList.add('hidden');
          setTimeout(autoSelectTrump, 1500);
        } else {
          document.getElementById('trump-instructions').textContent = "Select the trump suit:";
          document.getElementById('trump-buttons').classList.remove('hidden');
        }
      }, 1500);
    }
    
    /***** Trump Selection Phase *****/
    function selectTrump(suit) {
      trumpSuit = suit;
      updateTrumpDisplay();
      if (bidWinner === "player") {
        gamePhase = "kitty";
        updateSections();
        updateKittyPhase();
      }
    }
    function autoSelectTrump() {
      const randomSuit = suits[Math.floor(Math.random() * suits.length)];
      trumpSuit = randomSuit;
      updateTrumpDisplay();
      competitorHand = competitorHand.concat(kitty);
      while (competitorHand.length > 5) {
        competitorHand.splice(Math.floor(Math.random() * competitorHand.length), 1);
      }
      gamePhase = "draw";
      updateSections();
      updateDrawPhase();
    }
    
    /***** Kitty Phase (for player win) *****/
    function updateKittyPhase() {
      document.getElementById('trump-section').classList.add('hidden');
      document.getElementById('kitty-section').classList.remove('hidden');
      const combined = playerHand.concat(kitty);
      const container = document.getElementById('combined-hand');
      container.innerHTML = "";
      combined.forEach((card, index) => {
        const div = document.createElement('div');
        div.className = 'card';
        div.textContent = card.rank + card.suit;
        div.dataset.index = index;
        div.onclick = () => {
          if (div.classList.contains('selected')) {
            div.classList.remove('selected');
          } else {
            const selected = container.querySelectorAll('.selected');
            if (selected.length < 5) {
              div.classList.add('selected');
            }
          }
        };
        container.appendChild(div);
      });
    }
    function confirmKittySelection() {
      const container = document.getElementById('combined-hand');
      const selectedDivs = container.querySelectorAll('.selected');
      let selectedCards = [];
      const combined = playerHand.concat(kitty);
      selectedDivs.forEach(div => {
        selectedCards.push(combined[parseInt(div.dataset.index)]);
      });
      if (selectedCards.length > 5) {
        alert("You can keep at most 5 cards.");
        return;
      }
      playerHand = selectedCards;
      gamePhase = "draw";
      updateSections();
      updateDrawPhase();
    }
    
    /***** Draw Phase (for both competitor win and player win) *****/
    function updateDrawPhase() {
      document.getElementById('trump-section').classList.add('hidden');
      document.getElementById('draw-section').classList.remove('hidden');
      const container = document.getElementById('draw-hand');
      container.innerHTML = "";
      if (bidWinner === "player") {
        // For player win: simply display kept cards; no discarding.
        playerHand.forEach(card => {
          const div = document.createElement('div');
          div.className = 'card';
          div.textContent = card.rank + card.suit;
          container.appendChild(div);
        });
        container.style.pointerEvents = "none";
        const instructions = document.getElementById('draw-phase-instructions');
        let needToDraw = 5 - playerHand.length;
        instructions.textContent = needToDraw > 0 
          ? "You have kept " + playerHand.length + " cards. You need to draw " + needToDraw + " cards. Click 'Draw Cards' to draw them."
          : "You have a full 5‑card hand. Click 'Draw Cards' to continue.";
      } else {
        // For competitor win: allow discarding.
        container.style.pointerEvents = "auto";
        playerHand.forEach((card, index) => {
          const div = document.createElement('div');
          div.className = 'card';
          div.textContent = card.rank + card.suit;
          div.dataset.index = index;
          div.onclick = () => {
            if (div.classList.contains('selected')) {
              div.classList.remove('selected');
            } else {
              const selected = container.querySelectorAll('.selected');
              if (selected.length < 4) { // up to 4 cards
                div.classList.add('selected');
              }
            }
          };
          container.appendChild(div);
        });
        document.getElementById('draw-phase-instructions').textContent = "Select any cards to discard (0–4) and click 'Draw Cards'.";
      }
    }
    function confirmDraw() {
      if (bidWinner === "player") {
        let required = 5 - playerHand.length;
        for (let i = 0; i < required; i++) {
          if (deck.length > 0) {
            playerHand.push(deck.pop());
          }
        }
        startTrickPlay();
      } else {
        const container = document.getElementById('draw-hand');
        const selectedDivs = container.querySelectorAll('.selected');
        let discardIndices = [];
        selectedDivs.forEach(div => {
          discardIndices.push(parseInt(div.dataset.index));
        });
        discardIndices.sort((a, b) => b - a);
        discardIndices.forEach(idx => {
          playerHand.splice(idx, 1);
        });
        while (playerHand.length < 5 && deck.length > 0) {
          playerHand.push(deck.pop());
        }
        startTrickPlay();
      }
    }
    
    /***** Trick Play Phase *****/
    function startTrickPlay() {
      gamePhase = "trick";
      trickCards = [];
      handPlayedCards = [];
      trickNumber = 1;
      // Set the lead for the first trick to the bid winner.
      trickTurn = bidWinner;
      if (trickTurn === "competitor") {
        setTimeout(competitorPlayCard, 1000);
      }
      document.getElementById('bidding-section').classList.add('hidden');
      document.getElementById('trump-section').classList.add('hidden');
      document.getElementById('kitty-section').classList.add('hidden');
      document.getElementById('draw-section').classList.add('hidden');
      document.getElementById('trick-section').classList.remove('hidden');
      document.getElementById('trick-log').innerHTML = "";
      updateTrickUI();
    }
    function updateTrickUI() {
      const handDiv = document.getElementById('player-hand-trick');
      handDiv.innerHTML = "";
      playerHand.forEach((card, index) => {
        const div = document.createElement('div');
        div.className = 'card';
        div.textContent = card.rank + card.suit;
        div.dataset.index = index;
        div.onclick = () => { if (gamePhase === "trick" && trickTurn === "player") playPlayerCard(index); };
        handDiv.appendChild(div);
      });
      document.getElementById('trick-area').innerHTML = "";
      document.getElementById('trick-info').textContent = "Trick " + trickNumber + " of 5. " +
        (trickTurn === "player" ? "Your turn to lead." : "Computer leads.");
      if (gamePhase === "trick" && trickTurn === "competitor" && trickCards.length === 0) {
        setTimeout(competitorPlayCard, 1000);
      }
    }
    function playPlayerCard(index) {
      if (gamePhase !== "trick" || trickTurn !== "player") return;
      const card = playerHand.splice(index, 1)[0];
      trickCards.push({ card: card, player: "player" });
      updateTrickArea();
      trickTurn = "competitor";
      setTimeout(competitorPlayCard, 1000);
    }
    function competitorPlayCard() {
      if (competitorHand.length === 0) return;
      const idx = Math.floor(Math.random() * competitorHand.length);
      const card = competitorHand.splice(idx, 1)[0];
      trickCards.push({ card: card, player: "competitor" });
      updateTrickArea();
      trickTurn = "player";
      setTimeout(evaluateTrick, 1000);
    }
    function updateTrickArea() {
      const trickDiv = document.getElementById('trick-area');
      trickDiv.innerHTML = "";
      trickCards.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'card';
        div.textContent = entry.card.rank + entry.card.suit;
        trickDiv.appendChild(div);
      });
    }
    // Updated evaluateTrick with trump rules:
    // 1. If any played card is the 5 of trump, that card wins immediately.
    // 2. Otherwise, if one card is trump and the other is not, trump wins.
    // 3. If both are trump, compare values.
    // 4. If neither is trump, then only cards following the led suit are compared.
    function evaluateTrick() {
      if (trickCards.length < 2) return;
      handPlayedCards.push(...trickCards);
      
      // Check if any card is the 5 of trump.
      let fiveTrump = trickCards.find(entry => entry.card.rank === "5" && isTrump(entry.card));
      let winning;
      if (fiveTrump) {
        winning = fiveTrump;
      } else {
        let ledSuit = trickCards[0].card.suit;
        winning = trickCards[0];
        trickCards.forEach(entry => {
          let entryIsTrump = isTrump(entry.card);
          let winningIsTrump = isTrump(winning.card);
          if (entryIsTrump && !winningIsTrump) {
            winning = entry;
          } else if (entryIsTrump && winningIsTrump) {
            if (entry.card.value > winning.card.value) {
              winning = entry;
            }
          } else if (!entryIsTrump && !winningIsTrump) {
            let entryFollows = (entry.card.suit === ledSuit);
            let winningFollows = (winning.card.suit === ledSuit);
            if (entryFollows && !winningFollows) {
              winning = entry;
            } else if (entryFollows && winningFollows) {
              if (entry.card.value > winning.card.value) {
                winning = entry;
              }
            }
          }
        });
      }
      
      if (winning.player === "player") {
        playerTricks++;
      } else {
        competitorTricks++;
      }
      let playerCard = trickCards.find(e => e.player === "player");
      let compCard = trickCards.find(e => e.player === "competitor");
      let trickMessage = "Trick " + trickNumber + ": You played " +
                         (playerCard ? (playerCard.card.rank + playerCard.card.suit) : "–") +
                         ", Computer played " +
                         (compCard ? (compCard.card.rank + compCard.card.suit) : "–") +
                         ". Winner: " + (winning.player === "player" ? "You" : "Computer") +
                         " (" + winning.card.rank + winning.card.suit + ").";
      appendTrickLog(trickMessage);
      trickCards = [];
      trickNumber++;
      trickTurn = winning.player;
      if (playerHand.length === 0 && competitorHand.length === 0) {
        endHand();
      } else {
        updateTrickUI();
      }
    }
    function appendTrickLog(message) {
      const logDiv = document.getElementById('trick-log');
      const p = document.createElement('div');
      p.textContent = message;
      logDiv.appendChild(p);
    }
    
    /***** End of Hand & Game Over *****/
    function endHand() {
      gamePhase = "finished";
      document.getElementById('trick-section').classList.add('hidden');
      // Determine bonus: highest-ranking trump card wins bonus; if none, highest overall card.
      let trumpCards = handPlayedCards.filter(entry => isTrump(entry.card));
      let bonusWinner = null;
      if (trumpCards.length > 0) {
        let bonusCard = trumpCards.reduce((acc, curr) => (getCardBonusRank(curr.card) > getCardBonusRank(acc.card)) ? curr : acc);
        bonusWinner = bonusCard.player;
      } else {
        let bonusCard = handPlayedCards.reduce((acc, curr) => (curr.card.value > acc.card.value) ? curr : acc);
        bonusWinner = bonusCard.player;
      }
      let roundPlayerPoints = playerTricks * 5 + (bonusWinner === "player" ? 5 : 0);
      let roundCompetitorPoints = competitorTricks * 5 + (bonusWinner === "competitor" ? 5 : 0);
      cumulativePlayerScore += roundPlayerPoints;
      cumulativeCompetitorScore += roundCompetitorPoints;
      let handResult = "Hand " + (++handNumber) + ": You won " + playerTricks + " tricks (" + (playerTricks*5) +
                       (bonusWinner === "player" ? " + Bonus (5)" : "") + "); " +
                       "Computer won " + competitorTricks + " tricks (" + (competitorTricks*5) +
                       (bonusWinner === "competitor" ? " + Bonus (5)" : "") + "). " +
                       "Round Total: You " + roundPlayerPoints + " vs. Computer " + roundCompetitorPoints + ".";
      handLogMessages.push(handResult);
      updateScoreboard();
      
      if (cumulativePlayerScore >= 120 || cumulativeCompetitorScore >= 120) {
        let winner = cumulativePlayerScore >= 120 ? "You" : "Computer";
        document.getElementById('result-message').textContent = "Game Over! " + winner + " win the game.\n" + handResult;
        document.getElementById('result-section').classList.remove('hidden');
      } else {
        setTimeout(nextHand, 3000);
      }
    }
    function nextHand() {
      isPlayerDealer = !isPlayerDealer;
      updateDealerInfo();
      playerTricks = 0;
      competitorTricks = 0;
      trickCards = [];
      handPlayedCards = [];
      trickNumber = 1;
      trumpSuit = null;
      playerBid = 0;
      competitorBid = 0;
      bidWinner = null;
      document.getElementById('bidding-message').textContent = "";
      gamePhase = "bidding";
      updateTrumpDisplay();
      updateSections();
      dealCards();
    }
    function resetGame() {
      cumulativePlayerScore = 0;
      cumulativeCompetitorScore = 0;
      handNumber = 0;
      handLogMessages = [];
      isPlayerDealer = undefined;
      updateScoreboard();
      resetHandState();
      gamePhase = "bidding";
      updateTrumpDisplay();
      updateSections();
      dealCards();
    }
    function resetHandState() {
      playerTricks = 0;
      competitorTricks = 0;
      trickCards = [];
      handPlayedCards = [];
      trickNumber = 1;
      trumpSuit = null;
      playerBid = 0;
      competitorBid = 0;
      bidWinner = null;
    }
    
    /***** Section Visibility Control *****/
    function updateSections() {
      document.getElementById('bidding-section').classList.add('hidden');
      document.getElementById('trump-section').classList.add('hidden');
      document.getElementById('kitty-section').classList.add('hidden');
      document.getElementById('draw-section').classList.add('hidden');
      document.getElementById('trick-section').classList.add('hidden');
      if (gamePhase === "bidding") {
        document.getElementById('bidding-section').classList.remove('hidden');
        updateBiddingUI();
      } else if (gamePhase === "trump") {
        document.getElementById('trump-section').classList.remove('hidden');
      } else if (gamePhase === "kitty") {
        document.getElementById('kitty-section').classList.remove('hidden');
      } else if (gamePhase === "draw") {
        document.getElementById('draw-section').classList.remove('hidden');
      } else if (gamePhase === "trick") {
        document.getElementById('trick-section').classList.remove('hidden');
      }
      updateTrumpDisplay();
    }
    
    /***** Initialize Game on Page Load *****/
    window.onload = dealCards;
  </script>
</body>
</html>
