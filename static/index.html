<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>45's Game - Learn & Play</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* CSS Variables for themes */
    :root {
      --bg-color: #35654d;
      --card-back-bg: #333;
      --card-border-color: #333;
    }
    .theme-modern {
      --bg-color: #1e1e1e;
      --card-back-bg: #555;
      --card-border-color: #777;
    }
    /* Basic styles */
    body {
      font-family: sans-serif;
      background-color: var(--bg-color);
      margin: 0;
      padding: 20px;
      text-align: center;
      color: #fff;
    }
    .container {
      position: relative;
      max-width: 900px;
      margin: auto;
      background: rgba(0,0,0,0.7);
      padding: 20px;
      border-radius: 8px;
      transition: background-color 0.5s;
    }
    #game-options, #instructions {
      max-width: 900px;
      margin: 20px auto;
      background: rgba(255,255,255,0.1);
      padding: 10px;
      border-radius: 8px;
    }
    #instructions {
      text-align: left;
      font-size: 14px;
      display: none;
    }
    /* Tutorial Modal with Next buttons */
    #tutorial-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #tutorial-content {
      background: #fff;
      color: #000;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      text-align: left;
    }
    /* Dealer indicator */
    .dealer-indicator {
      display: inline-block;
      background: #fff;
      color: #000;
      border-radius: 5px;
      padding: 5px 10px;
      margin: 5px;
      font-weight: bold;
    }
    /* Card back style */
    .card-back {
      display: inline-block;
      width: 60px;
      height: 90px;
      background-color: var(--card-back-bg);
      border: 1px solid var(--card-border-color);
      border-radius: 5px;
      margin: 5px;
      line-height: 90px;
      color: #fff;
      font-size: 20px;
    }
    /* Card style: using images */
    .card {
      display: inline-block;
      width: 60px;
      height: 90px;
      border: 1px solid var(--card-border-color);
      border-radius: 5px;
      margin: 5px;
      cursor: pointer;
      user-select: none;
      transition: transform 0.3s ease;
    }
    .card img {
      width: 100%;
      height: 100%;
      border-radius: 5px;
    }
    .card.selected {
      transform: scale(1.1);
    }
    button {
      padding: 10px 15px;
      margin: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    /* Display areas */
    #trump-display { font-weight: bold; margin-bottom: 10px; }
    #dealer-info { margin-bottom: 10px; }
    #competitor-bid { font-size: 16px; font-weight: bold; margin-bottom: 5px; color: #ffeb3b; }
    #trick-log {
      margin-top: 10px;
      text-align: left;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      background: #fafafa;
      padding: 10px;
      border: 1px solid #ccc;
      font-size: 14px;
      max-height: 150px;
      overflow-y: auto;
      color: #000;
    }
    #won-tricks-section {
      margin-top: 20px;
    }
    #won-tricks-section h3 {
      margin-bottom: 10px;
    }
    #scoreboard-section {
      border-top: 2px solid #ffeb3b;
      padding-top: 10px;
    }
    #draw-phase-instructions { margin-top: 10px; font-style: italic; }
    #feedback {
      background: rgba(255,255,255,0.2);
      padding: 10px;
      border-radius: 5px;
      margin: 10px auto;
      max-width: 800px;
      font-size: 14px;
    }
    /* Responsive adjustments */
    @media (max-width: 600px) {
      .card, .card-back {
        width: 45px;
        height: 67px;
      }
    }
  </style>
</head>
<body>
  <!-- Theme Selector -->
  <div id="theme-options" style="margin-bottom:10px;">
    <label for="theme-select">Theme:</label>
    <select id="theme-select" onchange="switchTheme()">
      <option value="default">Classic</option>
      <option value="modern">Modern</option>
    </select>
  </div>

  <!-- Tutorial Modal -->
  <div id="tutorial-modal">
    <div id="tutorial-content">
      <h2>Welcome to Forty‑Fives!</h2>
      <div id="tutorial-step-content">
        <!-- Demo steps will be injected here -->
        <p>Step 1: This is a demonstration of how the game works.</p>
      </div>
      <div>
        <button onclick="prevTutorialStep()">Previous</button>
        <button onclick="nextTutorialStep()">Next</button>
        <button onclick="closeTutorial()">Close Tutorial</button>
      </div>
    </div>
  </div>

  <!-- Game Options Panel -->
  <div id="game-options">
    <h2>Game Options</h2>
    <label for="mode-select">Select Game Mode:</label>
    <select id="mode-select">
      <option value="2p">2-Player (You vs. Computer)</option>
      <option value="3p">Three-Way Cut-Throat (You vs. 2 Computers)</option>
    </select>
    <label>
      <input type="checkbox" id="instruction-mode"> Enable Tutorial Mode
    </label>
    <button onclick="startGame()">Start Game</button>
    <button onclick="openTutorial()">Show Tutorial</button>
    <button onclick="toggleInstructions()">Show Detailed Rules</button>
  </div>
  
  <!-- Detailed Instructions Panel -->
  <div id="instructions">
    <h3>Detailed Rules & Strategies for Forty‑Fives</h3>
    <p>
      <strong>Overview:</strong><br>
      Forty‑Fives is a trick‑taking game. You bid on how many points you can win and then play cards round by round. The player who wins a trick leads the next trick.
    </p>
    <p>
      <strong>Bidding:</strong><br>
      - In heads‑up, if you're the dealer you’ll see your opponent’s bid (for example, “Bill Passed” or “Bill bid 15”).<br>
      - In middle positions, you see the previous bids before making your own decision.<br>
      - If everyone passes, the dealer is forced to bid 15 (“bagged”).
    </p>
    <p>
      <strong>Trump & Trick Play:</strong><br>
      - The winning bidder selects a trump suit while your cards remain visible.<br>
      - All cards played in each trick are shown face‑up on the table. When a trick is won, the cards are placed face‑down (using a card‑back image) on that player’s side.<br>
      - The Ace of Hearts is always trump.
    </p>
    <p>
      <strong>Scoring:</strong><br>
      - Each trick is worth 5 points (with the bonus trick adding 5 extra points).<br>
      - If the bidder fails to meet their bid, they lose that many points.<br>
      - When the game is over, a detailed score sheet with a full trick log is shown.
    </p>
    <button onclick="toggleInstructions()">Hide Detailed Rules</button>
  </div>
  
  <!-- Main Game Container -->
  <div class="container" id="game-container" style="display:none;">
    <!-- Logo -->
    <div id="logo">45</div>
    <!-- Dealer Indicator (shown in 2p if you're the dealer) -->
    <div id="dealer-info"></div>
    <div id="trump-display"></div>
    
    <!-- Bidding Phase -->
    <div id="bidding-section" class="section">
      <h2>Bidding Phase</h2>
      <div id="competitor-bid"></div>
      <div>Your Hand:</div>
      <div id="player-hand-bidding" class="cards-container"></div>
      <div id="bid-options">
        <button onclick="placeBid(0)">Pass</button>
        <button onclick="placeBid(15)">Bid 15</button>
        <button onclick="placeBid(20)">Bid 20</button>
        <button onclick="placeBid(25)">Bid 25</button>
        <button onclick="placeBid(30)">Bid 30</button>
      </div>
      <div id="bidding-message"></div>
      <div id="bid-history"></div>
    </div>
    
    <!-- Trump Selection Phase -->
    <div id="trump-section" class="section hidden">
      <h2>Trump Selection</h2>
      <div>Your Hand:</div>
      <div id="player-hand-trump" class="cards-container"></div>
      <div id="trump-buttons" class="cards-container">
        <button onclick="selectTrump('♠')">♠</button>
        <button onclick="selectTrump('♥')">♥</button>
        <button onclick="selectTrump('♦')">♦</button>
        <button onclick="selectTrump('♣')">♣</button>
      </div>
    </div>
    
    <!-- Kitty Phase -->
    <div id="kitty-section" class="section hidden">
      <h2>Kitty Phase</h2>
      <div>Your Combined Hand (Your 5 cards + Kitty):</div>
      <div id="combined-hand" class="cards-container"></div>
      <div id="kitty-instructions">
        Click the cards you want to keep (up to 5 cards).
      </div>
      <button onclick="confirmKitty()">Confirm Selection</button>
    </div>
    
    <!-- Draw Phase -->
    <div id="draw-section" class="section hidden">
      <h2>Draw Phase</h2>
      <div id="draw-hand" class="cards-container"></div>
      <div id="draw-phase-instructions"></div>
      <button onclick="confirmDraw()">Draw Cards</button>
    </div>
    
    <!-- Trick Play Phase -->
    <div id="trick-section" class="section hidden">
      <h2>Trick Play</h2>
      <div id="trick-info"></div>
      <div>Your Hand:</div>
      <div id="player-hand-trick" class="cards-container"></div>
      <div>Trick Area (cards on the table):</div>
      <div id="trick-area" class="cards-container"></div>
      <div id="trick-log"></div>
    </div>
    
    <!-- Won Tricks Section -->
    <div id="won-tricks-section" class="section hidden">
      <h3>Your Won Tricks</h3>
      <div id="player-won-tricks" class="cards-container"></div>
      <h3>Opponent Won Tricks</h3>
      <div id="opponent-won-tricks" class="cards-container"></div>
    </div>
    
    <!-- Result Section -->
    <div id="result-section" class="section hidden">
      <h2>Game Over</h2>
      <div id="result-message"></div>
      <pre id="score-sheet"></pre>
      <button onclick="resetGame()">Play Again</button>
    </div>
    
    <!-- Scoreboard Section -->
    <div id="scoreboard-section" class="section">
      <h2>Scoreboard</h2>
      <div id="scoreboard"></div>
    </div>
    
    <!-- Feedback Area -->
    <div id="feedback"></div>
  </div>
  
  <script>
    let gameState = {};
    let tutorialSteps = [
      "Welcome to Forty‑Fives! In this demo, you’ll see how cards are dealt and how bidding works.",
      "During bidding, you’ll see the bids from all players. For example, if Bill passes, it shows 'Bill Passed'.",
      "After bidding, the winning bidder selects trump. Your cards remain visible so you know your hand.",
      "In trick play, every card played is shown face‑up on the table. The winner of the trick takes the cards (they appear as card backs on your side).",
      "At game end, a detailed score sheet is displayed, showing all hand summaries."
    ];
    let currentTutorialStep = 0;
    
    function showTutorialStep() {
      document.getElementById("tutorial-step-content").innerHTML = `<p>${tutorialSteps[currentTutorialStep]}</p>`;
    }
    function nextTutorialStep() {
      if (currentTutorialStep < tutorialSteps.length - 1) {
        currentTutorialStep++;
        showTutorialStep();
      }
    }
    function prevTutorialStep() {
      if (currentTutorialStep > 0) {
        currentTutorialStep--;
        showTutorialStep();
      }
    }
    
    // Theme switching: add a class to the body.
    function switchTheme() {
      const theme = document.getElementById("theme-select").value;
      if (theme === "modern") {
        document.body.classList.add("theme-modern");
      } else {
        document.body.classList.remove("theme-modern");
      }
    }
    
    // Tutorial Modal Functions
    function openTutorial() {
      currentTutorialStep = 0;
      showTutorialStep();
      document.getElementById("tutorial-modal").style.display = "flex";
    }
    function closeTutorial() {
      document.getElementById("tutorial-modal").style.display = "none";
    }
    
    // Update UI based on game state.
    function updateUI(state) {
      gameState = state;
      document.getElementById('trump-display').textContent =
        (state.gamePhase !== "bidding" && state.trumpSuit) ? "Trump Suit: " + state.trumpSuit : "";
      document.getElementById('bidding-message').textContent = state.biddingMessage || "";
      
      // Dealer indicator: in 2p mode, if you're the dealer.
      if (state.dealer && state.computerHandCount !== null && state.dealer === "player") {
        document.getElementById('dealer-info').innerHTML = '<div class="dealer-indicator">Dealer</div>';
      } else {
        document.getElementById('dealer-info').innerHTML = "";
      }
      
      // Display bid history.
      if (state.bidHistory) {
        let bhDiv = document.getElementById('bid-history');
        let bids = "";
        for (let p in state.bidHistory) {
          bids += `${p}: ${state.bidHistory[p]}<br>`;
        }
        bhDiv.innerHTML = "Bids:<br>" + bids;
      }
      
      // Hide all phase sections.
      ["bidding-section", "trump-section", "kitty-section", "draw-section", "trick-section", "result-section", "won-tricks-section"]
        .forEach(id => document.getElementById(id).classList.add("hidden"));

      // Bidding Phase
      if (state.gamePhase === "bidding") {
        document.getElementById('bidding-section').classList.remove("hidden");
        let container = document.getElementById('player-hand-bidding');
        container.innerHTML = "";
        state.playerHand.forEach(card => {
          container.appendChild(createCardImage(card));
        });
      }
      // Trump Selection Phase
      else if (state.gamePhase === "trump") {
        document.getElementById('trump-section').classList.remove("hidden");
        let handDiv = document.getElementById('player-hand-trump');
        handDiv.innerHTML = "";
        state.playerHand.forEach(card => {
          handDiv.appendChild(createCardImage(card));
        });
      }
      // Kitty Phase
      else if (state.gamePhase === "kitty") {
        document.getElementById('kitty-section').classList.remove("hidden");
        let container = document.getElementById('combined-hand');
        container.innerHTML = "";
        state.combinedHand.forEach((card, index) => {
          let img = createCardImage(card);
          img.dataset.index = index;
          img.onclick = () => img.classList.toggle('selected');
          container.appendChild(img);
        });
      }
      // Draw Phase
      else if (state.gamePhase === "draw") {
        document.getElementById('draw-section').classList.remove("hidden");
        let container = document.getElementById('draw-hand');
        container.innerHTML = "";
        state.drawHand.forEach(card => {
          container.appendChild(createCardImage(card));
        });
        document.getElementById('draw-phase-instructions').textContent = state.drawInstructions || "";
      }
      // Trick Phase
      else if (state.gamePhase === "trick") {
        document.getElementById('trick-section').classList.remove("hidden");
        let handContainer = document.getElementById('player-hand-trick');
        handContainer.innerHTML = "";
        state.playerHand.forEach((card, index) => {
          let img = createCardImage(card);
          if (state.currentTurn === "player") {
            img.onclick = () => playCard(index);
          }
          handContainer.appendChild(img);
        });
        let trickArea = document.getElementById('trick-area');
        trickArea.innerHTML = "";
        // If current trick is empty, show last trick.
        let trickCards = state.currentTrick.length ? state.currentTrick : state.lastTrick;
        trickCards.forEach(entry => {
          trickArea.appendChild(createCardImage(entry.card));
        });
        let trickLog = document.getElementById('trick-log');
        trickLog.innerHTML = "";
        (state.trickLog || []).forEach(msg => {
          let p = document.createElement('div');
          p.textContent = msg;
          trickLog.appendChild(p);
        });
      }
      // Finished Phase
      else if (state.gamePhase === "finished") {
        document.getElementById('result-section').classList.remove("hidden");
        document.getElementById('result-message').textContent = "Game Over!";
        document.getElementById('score-sheet').textContent = state.scoreSheet || "";
      }
      
      // Won Tricks Section: Display card-back images for each trick won.
      if (state.gamePhase !== "bidding" && state.gamePhase !== "trump" && state.gamePhase !== "kitty" && state.gamePhase !== "draw") {
        document.getElementById('won-tricks-section').classList.remove("hidden");
        let playerWonDiv = document.getElementById('player-won-tricks');
        playerWonDiv.innerHTML = "";
        for (let i = 0; i < state.wonTricks["player"]; i++) {
          let back = createCardBack();
          playerWonDiv.appendChild(back);
        }
        let opponentWonDiv = document.getElementById('opponent-won-tricks');
        opponentWonDiv.innerHTML = "";
        // For 2p, show the single opponent's won tricks.
        if (state.computerHandCount !== null) {
          let opponent = Object.keys(state.bidHistory).find(p => p !== "player");
          for (let i = 0; i < state.wonTricks[opponent]; i++) {
            let back = createCardBack();
            opponentWonDiv.appendChild(back);
          }
        }
      }
      
      document.getElementById('scoreboard').textContent = state.scoreboard || "";
      document.getElementById('feedback').textContent = state.feedback || "";
    }
    
    // Helper function to create an image element for a card.
    function createCardImage(card) {
      let img = document.createElement('img');
      img.className = "card";
      img.src = "cards/" + card.rank + "_" + card.suit.replace("♥", "Hearts").replace("♦", "Diamonds").replace("♣", "Clubs").replace("♠", "Spades") + ".png";
      img.alt = card.rank + card.suit;
      return img;
    }
    
    // Helper function to create a card back image.
    function createCardBack() {
      let img = document.createElement('img');
      img.className = "card";
      img.src = "cards/card_back.png";
      img.alt = "Card Back";
      return img;
    }
    
    async function callAPI(endpoint, method = "POST", data = {}) {
      try {
        let response = await fetch(endpoint, {
          method: method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        let result = await response.json();
        // For demonstration, force update wonTricks from state.
        if (!result.wonTricks && result.wonTricks !== 0) {
          result.wonTricks = { "player": 0 };
          for (let p in result.bidHistory) {
            if (p !== "player") result.wonTricks[p] = 0;
          }
        }
        updateUI(result);
      } catch(err) {
        console.error("API call error:", err);
      }
    }
    
    function startGame() {
      let mode = document.getElementById('mode-select').value;
      let instructional = document.getElementById('instruction-mode').checked;
      document.getElementById('game-options').style.display = "none";
      document.getElementById('game-container').style.display = "block";
      callAPI("/start_game", "POST", { mode: mode, instructional: instructional });
    }
    
    function placeBid(bid) {
      callAPI("/bid", "POST", { bid: bid });
    }
    
    function selectTrump(suit) {
      callAPI("/select_trump", "POST", { trump: suit });
    }
    
    function confirmKitty() {
      let container = document.getElementById('combined-hand');
      let selectedDivs = container.querySelectorAll('.selected');
      let indices = [];
      selectedDivs.forEach(div => indices.push(parseInt(div.dataset.index)));
      callAPI("/confirm_kitty", "POST", { keptIndices: indices });
    }
    
    function confirmDraw() {
      callAPI("/confirm_draw", "POST", {});
    }
    
    function playCard(cardIndex) {
      callAPI("/play_trick", "POST", { cardIndex: cardIndex });
    }
    
    function resetGame() {
      callAPI("/reset_game", "POST", {});
    }
    
    function toggleInstructions() {
      let instrDiv = document.getElementById('instructions');
      instrDiv.style.display = (instrDiv.style.display === "none" || instrDiv.style.display === "") ? "block" : "none";
    }
  </script>
</body>
</html>
